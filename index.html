<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8" />
				
	<!-- Include Bootstrap 4 CSS -->
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css" integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">
	
	<!-- Include Font Awesome 5 -->
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">
	
	<!-- Add local styles -->
	<style>
		/* Load the web font for the clocks */
		@import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');
		
		/* Apply the web font to the clock */
		.clock{
			font-family: 'Share Tech Mono', monospace;
		}
	</style>
	
	<title>This-Ti.me</title>
</head>
<body>

<!-- The Page Heading (temporary) -->
<header class="container my-3">
	<div class="row">
		<div class="col">
			<h1 class="display-1">This-Ti.me</h1>
		</div>
	</div>
</header>


<!-- The main page body -->
<main class="container my-3" style="min-width: 690px;">
	<div class="row">
		<div class="col">
			 <div class="card">
				<div class="card-header h3">
					You
				</div>
				<form action="javascript:void(0);" class="card-body form" id="you-fm" novalidate>
					<div class="form-group">
						<label for="you-timezone-tb">Your Time Zone</label>
						<div class="input-group">
							<input type="text" id="you-timezone-tb" class="form-control" autocomplete="off" required>
							<div class="input-group-append">
								<div class="input-group-text"><i class="fas fa-globe"></i></div>
							</div>
						</div>
						<small class="form-text text-muted">Enter an <a href="https://en.wikipedia.org/wiki/Tz_database" target="_blank" rel="noopener">IANA timezone string</a>, or just start typing a city name for auto-complete suggestions.</small>
					</div>
					<div class="form-group">
						<label for="you-timezone-tb">Your Name <small class="text-muted">(Optional)</small></label>
						<div class="input-group">
							<input type="text" id="you-name-tb" class="form-control">
							<div class="input-group-append">
								<div class="input-group-text"><i class="far fa-user"></i></div>
							</div>
						</div>
						<small class="form-text text-muted">Recipients see the shared time in their timezone and yours. If you enter a name, your time will be labeled with your name.</small>
					</div>
					<div class="form-group">
						<label for="you-link-tb">Personal Link</label>
						<div class="input-group">
							<div class="input-group-prepend">
								<div class="input-group-text"><i class="fas fa-link"></i></div>
							</div>
							<input type="text" class="form-control" id="you-link-tb">
							<div class="input-group-append">
								<button class="btn btn-secondary" type="button" id="you-link-btn">Generate</button>
							</div>
						</div>
						<small class="form-text text-muted">This link encodes your chosen timezone and name, bookmark or save it to save yourself a little time and effort.</small>
					</div>
				</form>
			 </div>
		</div>
		<div class="col">
			 <div class="card">
				<div class="card-header h3">
					Shared Time
				</div>
				<div class="card-body">
					<h1 class="h4 card-title">Your Time</h1>
					<h2 class="h5 card-subtitle text-muted" id="shared-yourTime-timezone"><em>Your Timezone</em></h6>
					<p class="card-text" id="shared-yourTime-time"></p>
					<h1 class="h4 card-title mt-3"><span id="shared-theirTime-name">Their</span> Time</h1>
					<h2 class="h5 card-subtitle text-muted" id="shared-theirTime-timezone"><em>Their Timezone</em></h6>
					<p class="card-text" id="shared-theirTime-time"></p>
				</div>
			 </div>
		</div>
		<div class="col">
			<div class="card">
				<div class="card-header h3">
					Share a Time
				</div>
				<form action="javascript:void(0);" class="card-body form" id="share-fm" novalidate>
					<div class="form-group">
						<label for="share-date">Date</label>
						<div class="input-group date" id="share-date-dp" data-target-input="nearest">
							<input type="text" class="form-control datetimepicker-input" data-target="#share-date-dp" id="share-date-tb" required>
							<div class="input-group-append" data-target="#share-date-dp" data-toggle="datetimepicker">
								<div class="input-group-text"><i class="far fa-calendar-alt"></i></div>
							</div>
						</div>
						<small class="form-text text-muted">Enter a date in your local format, e.g. <code id="share-date-example"></code>, or click the calendar icon to bring up a date picker.</small>
					</div>
					<div class="form-group">
						<label for="share-Time">Time</label>
						<div class="input-group date" id="share-time-dp" data-target-input="nearest">
							<input type="text" class="form-control datetimepicker-input" data-target="#share-time-dp"  id="share-time-tb" required>
							<div class="input-group-append" data-target="#share-time-dp" data-toggle="datetimepicker">
								<div class="input-group-text"><i class="far fa-clock"></i></div>
							</div>
						</div>
						<small class="form-text text-muted">Enter a time in 24 hour format, e.g. <code>02:15</code> or <code>14:15</code>, or click the clock icon to bring up a time picker.</small>
					</div>
					<div class="form-group">
						<label for="share-tb">Share Link</label>
						<div class="input-group">
							<div class="input-group-prepend">
								<div class="input-group-text"><i class="fas fa-link"></i></div>
							</div>
							<input type="text" class="form-control" id="share-tb">
							<div class="input-group-append">
								<button class="btn btn-success" type="button" id="share-btn">Generate</button>
							</div>
						</div>
						<small class="form-text text-muted">Share this link how ever you like. Recipients will see your shared time in their timezone and yours.</small>
					</div>
				</form>
			</div>
		</div>
	</div>
</main>

<!--
== Define Mustache Templates ==
-->

<script type="text/html" id="clock-tpl">
	<div class="clock display-1 text-center">
		<div class="badge badge-{{{bootstrapColor}}}">
			{{time}}<br>
			<small>{{date}}</small>
		</div>
	</div>
</script>

<!--
== Import JavaScript ==
-->

<!-- Include Bootstrap JavaScript from CDNs -->
<script src="https://code.jquery.com/jquery-3.4.0.min.js" integrity="sha256-BJeo0qm959uMBGb65z40ejJYGSgR7REI4+CW1fNKwOg=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>

<!-- Include Bootstrap 4 Autocomplete from CDN -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap-4-autocomplete/dist/bootstrap-4-autocomplete.min.js" crossorigin="anonymous"></script>

<!-- Include Moment.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.25.3/moment-with-locales.min.js" integrity="sha256-8d6kI5cQEwofkZmaPTRbKgyD70GN5mDpTYNP9YWhTlI=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.28/moment-timezone-with-data.min.js" integrity="sha256-IWYg4uIC8/erItNXYvLtyYHioRi2zT1TFva8qaAU/ww=" crossorigin="anonymous"></script>

<!-- Include Tempus Dominus from CDN -->
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/tempusdominus-bootstrap-4/5.0.1/js/tempusdominus-bootstrap-4.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tempusdominus-bootstrap-4/5.0.1/css/tempusdominus-bootstrap-4.min.css" />

<!-- Include URI.js from CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/URI.js/1.19.2/URI.min.js" integrity="sha512-YQAqeLT4VuAZV80lmk6OE3XtmMW3eDxUtNf2V2w16eypX21CDtelaVsFD1QLUBCQuJEenK3jPqYPmpNUasdktA==" crossorigin="anonymous"></script>

<!-- Include Mustache.js from CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mustache.js/4.0.1/mustache.min.js" integrity="sha512-6AXIWogbKpsHvoZJrJtHpIYES4wP8czSj0zk7ZfwOYS8GWYFNSykwdfapt7yQc4ikZytemBu+QyVObzBHJMwYg==" crossorigin="anonymous"></script>

<!-- This Page's Local JavaScript Code -->
<script type="text/javascript">
	//
	// === Global Variables ===
	//
	
	// template strings
	var TEMPLATES = {
		clock: '' // the template for rendering a clock
	};
	
	// the date & time formats
	var DATE_FORMAT = 'L';
	var TIME_FORMAT = 'HH:mm';
	var COMBINED_FORMAT = `${DATE_FORMAT} ${TIME_FORMAT}`;
	
	// jQuery objects representing important UI elements
	var $YOU_FM = null; // the 'you' form
	var $YOU_TIMEZONE_TB = null; // the text box for your timezone
	var $YOU_NAME_TB = null; // the text box for your name
	var $YOU_LINK_TB = null; // the text box for your personal link
	var $YOU_LINK_BTN = null; // the button for generating your personal link
	var $SHARED_YOURTIME_TIME = null; // the placeholder for the shared time in the recipient's timezone
	var $SHARED_YOURTIME_TIMEZONE = null; // the placeholder for the recipient's timezone
	var $SHARED_THEIRTIME_NAME = null; // the placeholder for the label for the sender's time
	var $SHARED_THEIRTIME_TIME = null; // the placeholder for the shared time in the sender's timezone
	var $SHARED_THEIRTIME_TIMEZONE = null; // the placeholder for the sender's timezone
	var $SHARE_FM = null; // the share form
	var $SHARE_DATE_DP = null; // the date picker for the sharing date
	var $SHARE_DATE_TB = null; // the text box for the sharing date
	var $SHARE_TIME_DP = null; // the time picker for the sharing date
	var $SHARE_TIME_TB = null; // the text box for the sharing time
	var $SHARE_BTN = null; // the button for generating the share link
	var $SHARE_TB = null; // the text box for holding the share link
	var $ALL_FM = null; // the 'you' and share forms
	
	// the infomration passed in the URL (if any)
	var URL_DATA = { timeShared: false };
	
	//
	// === Utility Functions ===
	//
	
	/**
	 * Convert an IANA timezone name to a human-friendly timezone name.
	 *
	 * This function simply replaces underscores with spaces.
	 *
	 * @param {string} ianaTZName
	 * @return {string}
	 */
	function ianaTZToHuman(ianaTZName){
		return String(ianaTZName).replaceAll('_', ' ');
	}
	
	/**
	 * Convert a human-friendly timezon name to an IANA timezone name.
	 *
	 * This function simply replaces spaces with underscores.
	 *
	 * @param {string} humanTZName
	 * @return {string}
	 */
	function humanTZToIANA(humanTZName){
		return String(humanTZName).replaceAll(' ', '_');
	}
	
	/**
	 * Sanitise a name.
	 *
	 * This function collapses all white space into single spaces, and trims the string.
	 *
	 * @param {string} name
	 * @return {string}
	 */
	function sanitiseName(name){
		return String(name).replace(/\s+/g, ' ').trim();
	}
	
	//
	// === UI Functions ===
	//
	
	/**
	 * Read my timezone in human-friendly form.
	 *
	 * @return {string} Ahuman-friendly timezone name, e.g. `'America/Los Angeles'`.
	 */
	function myTimezone(){
		return $YOU_TIMEZONE_TB.val();
	}
	
	/**
	 * Read my timezone as an IANA timezone name.
	 *
	 * @return {string} An IANA timezone name, e.g. `'America/Los_Angeles'`.
	 */
	function myIANATimezone(){
		return humanTZToIANA(myTimezone());
	}
	
	/**
	 * Read my name from the form.
	 *
	 * This function sanitises the name.
	 *
	 * @return {string}
	 */
	function myName(){
		return sanitiseName($YOU_NAME_TB.val());
	}
	
	/**
	 * Render a clock given a time as a moment object.
	 *
	 * @param {moment} time
	 * @param {boolean} [primarClock=false]
	 * @return {jQuery}
	 */
	function renderClock(time, primaryClock){
		return $(Mustache.render(
			TEMPLATES.clock,
			{
				time: time.format(TIME_FORMAT),
				date: time.format(DATE_FORMAT),
				bootstrapColor: primaryClock ? 'primary' : 'secondary'
			}
		));
	}
	
	/**
	 * Update the display of the shared time.
	 */
	function updateSharedTime(){
		// build a moment object representing the shared time
		const sharedTime = moment.tz(URL_DATA.uts, 'X', $YOU_TIMEZONE_TB.val());
		
		// render the time in your timezone
		$SHARED_YOURTIME_TIME.empty().append(renderClock(sharedTime, true));
		$SHARED_YOURTIME_TIMEZONE.text(myTimezone());
		
		// render the time in the sender's timezone
		const theirTime = moment(sharedTime).tz(URL_DATA.tz);
		let theirName = 'Their';
		if(URL_DATA.name){
			theirName = `${URL_DATA.name}'${ URL_DATA.name.match(/s$/i) ? '' : 's' }`;
		}
		$SHARED_THEIRTIME_NAME.text(theirName);
		$SHARED_THEIRTIME_TIME.empty().append(renderClock(theirTime));
		$SHARED_THEIRTIME_TIMEZONE.text(ianaTZToHuman(URL_DATA.tz));
	}
	
	//
	// === The Document Ready Handler ===
	//
	$(function(){
		//
		// -- extract data from URL
		//
		const rawURLInfo = (new URI()).query(true);
		if(rawURLInfo.uts && rawURLInfo.tz){
			URL_DATA.timeShared = true;
			URL_DATA.uts = rawURLInfo.uts;
			URL_DATA.tz = rawURLInfo.tz;
			if(rawURLInfo.name){
				URL_DATA.name = sanitiseName(rawURLInfo.name);
			}
		}
		if(rawURLInfo.mytz){
			URL_DATA.mytz = rawURLInfo.mytz;
		}
		if(rawURLInfo.myname){
			URL_DATA.myname = sanitiseName(rawURLInfo.myname);
		}
		
		//
		// -- init the global jQuery variables --
		//
		$YOU_FM = $('#you-fm');
		$YOU_TIMEZONE_TB = $('#you-timezone-tb');
		$YOU_NAME_TB = $('#you-name-tb');
		$YOU_LINK_TB = $('#you-link-tb');
		$YOU_LINK_BTN = $('#you-link-btn');
		$SHARED_YOURTIME_TIME = $('#shared-yourTime-time');
		$SHARED_YOURTIME_TIMEZONE = $('#shared-yourTime-timezone');
		$SHARED_THEIRTIME_NAME = $('#shared-theirTime-name');
		$SHARED_THEIRTIME_TIME = $('#shared-theirTime-time');
		$SHARED_THEIRTIME_TIMEZONE = $('#shared-theirTime-timezone');
		$SHARE_FM = $('#share-fm');
		$SHARE_DATE_DP = $('#share-date-dp');
		$SHARE_DATE_TB = $('#share-date-tb');
		$SHARE_TIME_DP = $('#share-time-dp');
		$SHARE_TIME_TB = $('#share-time-tb');
		$SHARE_BTN = $('#share-btn');
		$SHARE_TB = $('#share-tb');
		$ALL_FM = $().add($YOU_FM).add($SHARE_FM);
		
		//
		// -- load templates --
		//
		TEMPLATES.clock = $('#clock-tpl').html();
		
		//
		// -- Init the UI --
		//
		
		// build the set of timezones for use in the timezone dropdowns
		const tzAutoCompeleSource = {};
		let tzAutoCompleteCounter = 1;
		for(const tzName of moment.tz.names()){
			// break the timezone into parts
			const tzParts = tzName.split('\/');
			
			// skip timezones with more than two parts
			if(tzParts.length != 2) continue;
					
			// skip the artificial Etc region
			if(tzParts[0] === 'Etc') continue;
			
			// if we got here, add the timezone as an option
			tzAutoCompeleSource[ianaTZToHuman(tzName)] = tzAutoCompleteCounter;
			tzAutoCompleteCounter++;
		}
		
		// a local function for validating the pre-requisutes for saving a personal URL
		const validateSaving = function(){
			// get a list of all invalid inputs
			const $invalid = $('.is-invalid', $YOU_FM);
			
			if($invalid.length === 0){
				// no invalid fields
				$YOU_LINK_BTN.prop('disabled', false);
			}else{
				// at least one invalid field
				$YOU_LINK_BTN.prop('disabled', true);
			}
		};
		
		// a local function for validating the pre-requisutes for sharing
		const validateSharing = function(){
			// get a list of all invalid inputs
			const $invalid = $('.is-invalid', $ALL_FM);
			
			if($invalid.length === 0){
				// no invalid fields
				$SHARE_BTN.prop('disabled', false);
			}else{
				// at least one invalid field
				$SHARE_BTN.prop('disabled', true);
			}
		};
		
		// init the timezone input
		let defaultTz = Intl.DateTimeFormat().resolvedOptions().timeZone; // default to browser locale
		if(URL_DATA.mytz){
			defaultTz = URL_DATA.mytz; // use URL data if available
		}
		$YOU_TIMEZONE_TB.val(defaultTz).autocomplete({
			source: tzAutoCompeleSource, // the autocompelte values
			maximumItems: 10, // the maximum autocomplete suggestions
			treshold: 1, // the minimum number of characters to search
			onSelectItem: function(){ // event handler for selection of autocomplete suggestion
				$YOU_TIMEZONE_TB.trigger('input');
			}
		}).on('input', function(){
			// validate the timezone
			const tzObj = moment.tz.zone(myIANATimezone());
			if(tzObj){
				// not null, so time zone is valid
				$YOU_TIMEZONE_TB.removeClass('is-invalid').addClass('is-valid');
			}else{
				// timezone is invalid
				$YOU_TIMEZONE_TB.removeClass('is-valid').addClass('is-invalid');
			}
			
			// re-validate sharing & saving
			validateSharing();
			validateSaving();
		});
		
		// init the name input
		if(URL_DATA.myname){
			$YOU_NAME_TB.val(URL_DATA.myname);
		}
		
		// add an event handler to blank the personal link when any of the personal data changes
		$('input', $YOU_FM).on('input', function(){
			$YOU_LINK_TB.val('');
		});
		
		// init the personal link button
		$YOU_LINK_BTN.click(function(){
			// build the URL
			const saveInfo = {
				mytz: myIANATimezone()
			};
			const name = myName();
			if(name){
				saveInfo.myname = name;
			}
			const saveURL = URI().query(saveInfo);
			
			
			// write the URL to the textbox and select it
			$YOU_LINK_TB.val(saveURL.toString()).select();
		});
		
		// init the date picker
		const startOfDay = moment().startOf('day');
		$('#share-date-example').text(startOfDay.format(DATE_FORMAT));
		$SHARE_DATE_DP.datetimepicker({
			format: DATE_FORMAT,
			minDate: startOfDay,
			defaultDate: moment()
        });
		$SHARE_DATE_TB.on('input', function(){
			// validate the date
			const dObj = moment($SHARE_DATE_TB.val(), DATE_FORMAT, true);
			if(dObj && dObj.isValid()){
				// the date is valid, so mark it as such
				$SHARE_DATE_TB.removeClass('is-invalid').addClass('is-valid');
			}else{
				// the date is invalid
				$SHARE_DATE_TB.removeClass('is-valid').addClass('is-invalid');
			}
			
			// re-validate sharing
			validateSharing();
		});
		
		// init the time picker
		$SHARE_TIME_DP.datetimepicker({
			format: TIME_FORMAT,
			defaultDate: moment().startOf('hour').add(1, 'hour'),
			stepping: 15
        });
		$SHARE_TIME_TB.on('input', function(){
			// validate the time
			const tObj = moment($SHARE_TIME_TB.val(), TIME_FORMAT, true);
			if(tObj && tObj.isValid()){
				// the time is valid, so mark it as such
				$SHARE_TIME_TB.removeClass('is-invalid').addClass('is-valid');
			}else{
				// the date is invalid
				$SHARE_TIME_TB.removeClass('is-valid').addClass('is-invalid');
			}
			
			// re-validate sharing
			validateSharing();
		});
		
		// add an event handler to blank the share link when any of the relevant data changes
		$('input', $ALL_FM).on('input', function(){
			$SHARE_TB.val('');
		});
		
		// add a click handler to the generate button
		$SHARE_BTN.click(function(){
			// build objects representing the timezone and date time
			const shareTZ = myIANATimezone();
			const shareDate = moment.tz(`${$SHARE_DATE_TB.val()} ${$SHARE_TIME_TB.val()}`, COMBINED_FORMAT, shareTZ);
			
			// build the URL
			const shareInfo = {
				uts: shareDate.unix(),
				tz: shareTZ
			};
			const name = myName();
			if(name){
				shareInfo.name = name;
			}
			const shareURL = URI().query(shareInfo);
			
			
			// write the URL to the textbox and select it
			$SHARE_TB.val(shareURL.toString()).select();
		});
		
		//
		// -- Load The Shared Time (if any) --
		//
		
		if(URL_DATA.timeShared){
			updateSharedTime();
		}
    });
</script>

</body>
</html>